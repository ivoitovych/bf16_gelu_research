// ============================================================================
// DOPRI-64 PIECEWISE POLYNOMIAL APPROXIMATION (CORRECT REFERENCE)
// ============================================================================
//
// Generated using erfc-based reference matching gelu_implementations.cpp
// This ensures accurate ULP measurements.
//
// 64 segments, degree 5 polynomials
// Polynomial region: [-13.5625, 3.5]
// Identity region: [3.5, âˆž)
//
// Region distribution:
//   [-13.5625, -9.0]: 24 segments (deep negative, subnormal outputs)
//   [-9.0, -5.0]:      8 segments (moderate negative)
//   [-5.0, -0.5]:      8 segments (mild negative)
//   [-0.5, 0.0]:       4 segments (near-zero, p(0)=0 constraint)
//   [0.0, 0.5]:        4 segments (near-zero, p(0)=0 constraint)
//   [0.5, 3.5]:       16 segments (positive)
//
// ============================================================================

#define DOPRI64_N_SEGMENTS 64
#define DOPRI64_DEGREE 5
#define DOPRI64_SAT_LOW   -13.5625f
#define DOPRI64_SAT_HIGH   3.5f

static const float dopri64_breakpoints[65] = {
    -13.5625000000f, -13.3723958333f, -13.1822916667f, -12.9921875000f, -12.8020833333f, -12.6119791667f, -12.4218750000f, -12.2317708333f,
    -12.0416666667f, -11.8515625000f, -11.6614583333f, -11.4713541667f, -11.2812500000f, -11.0911458333f, -10.9010416667f, -10.7109375000f,
    -10.5208333333f, -10.3307291667f, -10.1406250000f, -9.9505208333f, -9.7604166667f, -9.5703125000f, -9.3802083333f, -9.1901041667f,
    -9.0000000000f, -8.5000000000f, -8.0000000000f, -7.5000000000f, -7.0000000000f, -6.5000000000f, -6.0000000000f, -5.5000000000f,
    -5.0000000000f, -4.4375000000f, -3.8750000000f, -3.3125000000f, -2.7500000000f, -2.1875000000f, -1.6250000000f, -1.0625000000f,
    -0.5000000000f, -0.3750000000f, -0.2500000000f, -0.1250000000f, 0.0000000000f, 0.1250000000f, 0.2500000000f, 0.3750000000f,
    0.5000000000f, 0.6875000000f, 0.8750000000f, 1.0625000000f, 1.2500000000f, 1.4375000000f, 1.6250000000f, 1.8125000000f,
    2.0000000000f, 2.1875000000f, 2.3750000000f, 2.5625000000f, 2.7500000000f, 2.9375000000f, 3.1250000000f, 3.3125000000f,
    3.5000000000f
};

static const float dopri64_coeffs[DOPRI64_N_SEGMENTS][DOPRI64_DEGREE + 1] = {
    /* seg  0 */ { -2.036425963468e-34f, 5.236583456396e-34f, 1.657365181542e-34f, 1.876357291015e-35f, 9.336172081829e-37f, 1.734415812811e-38f },
    /* seg  1 */ { -2.365306657031e-33f, 5.988291248468e-33f, 1.925964329815e-33f, 2.212652989457e-34f, 1.116858135401e-35f, 2.104562376110e-37f },
    /* seg  2 */ { -2.647025922284e-32f, 6.595005710591e-32f, 2.156085065385e-32f, 2.514186149607e-33f, 1.287673102540e-34f, 2.461718954951e-36f },
    /* seg  3 */ { -2.851947038471e-31f, 6.992726436205e-31f, 2.324460947038e-31f, 2.751799420949e-32f, 1.430343329725e-33f, 2.774804151141e-35f },
    /* seg  4 */ { -2.960649203409e-30f, 7.140570170803e-30f, 2.414205753885e-30f, 2.902264973714e-31f, 1.531347702357e-32f, 3.015228539531e-34f },
    /* seg  5 */ { -2.960194958914e-29f, 7.020476445737e-29f, 2.414983410401e-29f, 2.948843958993e-30f, 1.579797484217e-31f, 3.157906929604e-33f },
    /* seg  6 */ { -2.850478758105e-28f, 6.645666208371e-28f, 2.326681699767e-28f, 2.886417508667e-29f, 1.570450311323e-30f, 3.187671410198e-32f },
    /* seg  7 */ { -2.643030360488e-27f, 6.055973614529e-27f, 2.158649595801e-27f, 2.721456597287e-28f, 1.504136041338e-29f, 3.100919441514e-31f },
    /* seg  8 */ { -2.360212062660e-26f, 5.312835767783e-26f, 1.928785306517e-26f, 2.471827886683e-27f, 1.388142948112e-28f, 2.907355480679e-30f },
    /* seg  9 */ { -2.029586935095e-25f, 4.486583249306e-25f, 1.659578471682e-25f, 2.162562906833e-26f, 1.234320030760e-27f, 2.627011355935e-29f },
    /* seg 10 */ { -1.680348758144e-24f, 3.646759545534e-24f, 1.374937944597e-24f, 1.822281321010e-25f, 1.057385762905e-26f, 2.287444910507e-28f },
    /* seg 11 */ { -1.339782070225e-23f, 2.853074158715e-23f, 1.096903764535e-23f, 1.479088847745e-24f, 8.727557706585e-26f, 1.919599046560e-27f },
    /* seg 12 */ { -1.028330445925e-22f, 2.148038979381e-22f, 8.424843323237e-23f, 1.156151171253e-23f, 6.939325368999e-25f, 1.552229232235e-26f },
    /* seg 13 */ { -7.598114540382e-22f, 1.556229805236e-21f, 6.229502398316e-22f, 8.703070700180e-23f, 5.315054281888e-24f, 1.209460390303e-25f },
    /* seg 14 */ { -5.404892340681e-21f, 1.084905370598e-20f, 4.434464121918e-21f, 6.309176800409e-22f, 3.921698761685e-23f, 9.080984561526e-25f },
    /* seg 15 */ { -3.700690383963e-20f, 7.276627295347e-20f, 3.038541731862e-20f, 4.404122626235e-21f, 2.787180014341e-22f, 6.569492490894e-24f },
    /* seg 16 */ { -2.438835416225e-19f, 4.695184747152e-19f, 2.004021805377e-19f, 2.960164945452e-20f, 1.907957194685e-21f, 4.579117180587e-23f },
    /* seg 17 */ { -1.546785707297e-18f, 2.914110373491e-18f, 1.272066400983e-18f, 1.915600126552e-19f, 1.257919014862e-20f, 3.075071007288e-22f },
    /* seg 18 */ { -9.441118379442e-18f, 1.739602433193e-17f, 7.770755324655e-18f, 1.193465281519e-18f, 7.987425219657e-20f, 1.989514873970e-21f },
    /* seg 19 */ { -5.544615049142e-17f, 9.986565735182e-17f, 4.567767480877e-17f, 7.157765829086e-18f, 4.884081118304e-19f, 1.239980128665e-20f },
    /* seg 20 */ { -3.132931570229e-16f, 5.512526762582e-16f, 2.583422537795e-16f, 4.132180661205e-17f, 2.875800049585e-18f, 7.444602957318e-20f },
    /* seg 21 */ { -1.703164478769e-15f, 2.925538505115e-15f, 1.405756758544e-15f, 2.296132138515e-16f, 1.630508699802e-17f, 4.305495131925e-19f },
    /* seg 22 */ { -8.906124761457e-15f, 1.492446182461e-14f, 7.358325000090e-15f, 1.227913743994e-15f, 8.900612140383e-17f, 2.398330157875e-18f },
    /* seg 23 */ { -4.479379082712e-14f, 7.317541562833e-14f, 3.704757530226e-14f, 6.319166936085e-15f, 4.677612305487e-16f, 1.286712426773e-17f },
    /* seg 24 */ { -2.311438819035e-10f, -1.301952495568e-10f, -2.933719876407e-11f, -3.305679495862e-12f, -1.862598866812e-13f, -4.198386066462e-15f },
    /* seg 25 */ { -8.688192933012e-09f, -5.180016669929e-09f, -1.235560710736e-09f, -1.473788357671e-10f, -8.791059786955e-12f, -2.097826251377e-13f },
    /* seg 26 */ { -2.448490781354e-07f, -1.550154221770e-07f, -3.926555360012e-08f, -4.974097660823e-09f, -3.151216430532e-10f, -7.987102472672e-12f },
    /* seg 27 */ { -5.146302164424e-06f, -3.471982603944e-06f, -9.372660294753e-07f, -1.265477135509e-07f, -8.545651247287e-09f, -2.308974427955e-10f },
    /* seg 28 */ { -8.011324920404e-05f, -5.781897940567e-05f, -1.669951146095e-05f, -2.412700900755e-06f, -1.743649849926e-07f, -5.042563576925e-09f },
    /* seg 29 */ { -9.155802384661e-04f, -7.098491860047e-04f, -2.202939976452e-04f, -3.420570657921e-05f, -2.657279836642e-06f, -8.262154910839e-08f },
    /* seg 30 */ { -7.594449064905e-03f, -6.353180030315e-03f, -2.128205459350e-03f, -3.568157381210e-04f, -2.994022525889e-05f, -1.005798869267e-06f },
    /* seg 31 */ { -4.502767555174e-02f, -4.082233556512e-02f, -1.482909553594e-02f, -2.697668268018e-03f, -2.457377624235e-04f, -8.966246696110e-06f },
    /* seg 32 */ { -2.031637946081e-01f, -2.013891695461e-01f, -8.008022961929e-02f, -1.596341778448e-02f, -1.594951798457e-03f, -6.388476979782e-05f },
    /* seg 33 */ { -6.105812376742e-01f, -6.646748839809e-01f, -2.909911321804e-01f, -6.401351864768e-02f, -7.073031554418e-03f, -3.139101737552e-04f },
    /* seg 34 */ { -1.032669563760e+00f, -1.206577108415e+00f, -5.695782463874e-01f, -1.357000515322e-01f, -1.630625658473e-02f, -7.901220606783e-04f },
    /* seg 35 */ { -8.210425867559e-01f, -8.674644999852e-01f, -3.524971505869e-01f, -6.629698791792e-02f, -5.222976187676e-03f, -8.278253028132e-05f },
    /* seg 36 */ { -1.180608113469e-01f, 4.195430069135e-01f, 5.921498776097e-01f, 2.811671756422e-01f, 5.882241946921e-02f, 4.649535360040e-03f },
    /* seg 37 */ { 1.393366388709e-01f, 9.824461668288e-01f, 1.085137458181e+00f, 4.973112973741e-01f, 1.062657759088e-01f, 8.820513444593e-03f },
    /* seg 38 */ { 3.331465317822e-02f, 6.461350204172e-01f, 6.560098879948e-01f, 2.220468171981e-01f, 1.752697066858e-02f, -2.677548395246e-03f },
    /* seg 39 */ { 1.478129151046e-04f, 5.006155487599e-01f, 3.981744576965e-01f, -8.876638756252e-03f, -8.714396468989e-02f, -2.190532809139e-02f },
    /* seg 40 */ { 0.000000000000e+00f, 4.998932867636e-01f, 3.976740416276e-01f, -6.077745380905e-03f, -8.127632500122e-02f, -1.854129862220e-02f },
    /* seg 41 */ { 0.000000000000e+00f, 4.999765150286e-01f, 3.985537251597e-01f, -2.571227051879e-03f, -7.502820707622e-02f, -1.434212441672e-02f },
    /* seg 42 */ { 0.000000000000e+00f, 4.999981285705e-01f, 3.988891126701e-01f, -5.961123098503e-04f, -6.979256614432e-02f, -9.069406628236e-03f },
    /* seg 43 */ { 0.000000000000e+00f, 4.999999994118e-01f, 3.989420448563e-01f, -1.509319457085e-05f, -6.682898973213e-02f, -3.103072545301e-03f },
    /* seg 44 */ { 0.000000000000e+00f, 5.000000005882e-01f, 3.989420448563e-01f, 1.509319518836e-05f, -6.682898974006e-02f, 3.103072578847e-03f },
    /* seg 45 */ { 0.000000000000e+00f, 5.000018714296e-01f, 3.988891126686e-01f, 5.961123215195e-04f, -6.979256618467e-02f, 9.069406679842e-03f },
    /* seg 46 */ { 0.000000000000e+00f, 5.000234849718e-01f, 3.985537251541e-01f, 2.571227078722e-03f, -7.502820713296e-02f, 1.434212446152e-02f },
    /* seg 47 */ { 0.000000000000e+00f, 5.001067132373e-01f, 3.976740416196e-01f, 6.077745407930e-03f, -8.127632504178e-02f, 1.854129864496e-02f },
    /* seg 48 */ { -1.176314479603e-04f, 5.013335297960e-01f, 3.925172904871e-01f, 1.699155175317e-02f, -9.289874545064e-02f, 2.352006933703e-02f },
    /* seg 49 */ { 1.599494024140e-04f, 4.994535941290e-01f, 3.976048844495e-01f, 1.011597575990e-02f, -8.825990710650e-02f, 2.227053440663e-02f },
    /* seg 50 */ { 2.963461731285e-03f, 4.837533009943e-01f, 4.328539245040e-01f, -2.954539184446e-02f, -6.589324990601e-02f, 1.721270064189e-02f },
    /* seg 51 */ { 1.301277931091e-02f, 4.369043148313e-01f, 5.203654755846e-01f, -1.114211388032e-01f, -2.752427901117e-02f, 1.000764641743e-02f },
    /* seg 52 */ { 3.595122804593e-02f, 3.455272384938e-01f, 6.661551118429e-01f, -2.278730822029e-01f, 1.904509259639e-02f, 2.548678725451e-03f },
    /* seg 53 */ { 7.336029285922e-02f, 2.154810676032e-01f, 8.471660486390e-01f, -3.539714107678e-01f, 6.301047618872e-02f, -3.588915875285e-03f },
    /* seg 54 */ { 1.166519295969e-01f, 8.188089729327e-02f, 1.012210575786e+00f, -4.559936598781e-01f, 9.456678978509e-02f, -7.496088670197e-03f },
    /* seg 55 */ { 1.444802947448e-01f, 4.265625171041e-03f, 1.098844269700e+00f, -5.043677560866e-01f, 1.080788411853e-01f, -9.006509313996e-03f },
    /* seg 56 */ { 1.274868059151e-01f, 4.565744387380e-02f, 1.058524690724e+00f, -4.847345930653e-01f, 1.032999175481e-01f, -8.541333022746e-03f },
    /* seg 57 */ { 3.997452463962e-02f, 2.446664588616e-01f, 8.774290984859e-01f, -4.023044680297e-01f, 8.453233268240e-02f, -6.831449979396e-03f },
    /* seg 58 */ { -1.267362805114e-01f, 5.949852555201e-01f, 5.828665182783e-01f, -2.784200454891e-01f, 5.847192386708e-02f, -4.637829899797e-03f },
    /* seg 59 */ { -3.564675855668e-01f, 1.043117525698e+00f, 2.330931766593e-01f, -1.418763195779e-01f, 3.181185009582e-02f, -2.555040362266e-03f },
    /* seg 60 */ { -6.105571457521e-01f, 1.505483038220e+00f, -1.035431445063e-01f, -1.929527777228e-02f, 9.487839267227e-03f, -9.283779922103e-04f },
    /* seg 61 */ { -8.397603340346e-01f, 1.896345718234e+00f, -3.702225554766e-01f, 7.170153987823e-02f, -6.040821223028e-03f, 1.318577237650e-04f },
    /* seg 62 */ { -1.000221578747e+00f, 2.153931934835e+00f, -5.356556337650e-01f, 1.248363195127e-01f, -1.457558887909e-02f, 6.803243943655e-04f },
    /* seg 63 */ { -1.066458755903e+00f, 2.254674650212e+00f, -5.969533975697e-01f, 1.434874019250e-01f, -1.741345004375e-02f, 8.530652956830e-04f },
};

// Binary search for segment index
static inline int dopri64_find_segment(float x) {
    int lo = 0, hi = DOPRI64_N_SEGMENTS - 1;
    while (lo < hi) {
        int mid = (lo + hi + 1) / 2;
        if (x >= dopri64_breakpoints[mid]) {
            lo = mid;
        } else {
            hi = mid - 1;
        }
    }
    return lo;
}

// Horner's method for polynomial evaluation
static inline float dopri64_horner(int seg, float x) {
    float result = dopri64_coeffs[seg][DOPRI64_DEGREE];
    for (int i = DOPRI64_DEGREE - 1; i >= 0; i--) {
        result = result * x + dopri64_coeffs[seg][i];
    }
    return result;
}

/**
 * @brief DOPRI-64 Piecewise Polynomial GELU Approximation
 *
 * Generated with erfc-based reference matching C++ test framework.
 * Target: Max ULP <= 1 across polynomial region.
 *
 * - 64 segments, degree 5 polynomials
 * - Constrained p(0)=0 for near-zero segments
 * - Binary search segment lookup (6 comparisons)
 * - 5 FMA operations per evaluation (Horner's method)
 */
std::bfloat16_t gelu_dopri64(std::bfloat16_t x_bf16) {
    float x = static_cast<float>(x_bf16);

    // Saturation: x < -13.5625 -> 0
    if (x < DOPRI64_SAT_LOW) return static_cast<std::bfloat16_t>(0.0f);

    // Identity: x >= 3.5 -> x
    if (x >= DOPRI64_SAT_HIGH) return static_cast<std::bfloat16_t>(x);

    // Polynomial region: [-13.5625, 3.5)
    int seg = dopri64_find_segment(x);
    float result = dopri64_horner(seg, x);
    return static_cast<std::bfloat16_t>(result);
}